<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1>Mapper Wizard</h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <% if @search_endpoint.persisted? %>
      <%= link_to "Back to Endpoint", search_endpoint_path(@search_endpoint), class: "btn btn-sm btn-outline-secondary" %>
    <% else %>
      <%= link_to "Back to Search Endpoints", search_endpoints_path, class: "btn btn-sm btn-outline-secondary" %>
    <% end %>
  </div>
</div>

<% search_endpoint_id = @search_endpoint.persisted? ? @search_endpoint.id : 'new' %>

<div class="card"
     data-controller="mapper-wizard"
     data-mapper-wizard-search-endpoint-id-value="<%= search_endpoint_id %>"
     data-mapper-wizard-fetch-url-value="<%= mapper_wizard_fetch_html_path(search_endpoint_id) %>"
     data-mapper-wizard-generate-url-value="<%= mapper_wizard_generate_mappers_path(search_endpoint_id) %>"
     data-mapper-wizard-test-url-value="<%= mapper_wizard_test_mapper_path(search_endpoint_id) %>"
     data-mapper-wizard-refine-url-value="<%= mapper_wizard_refine_mapper_path(search_endpoint_id) %>"
     data-mapper-wizard-save-url-value="<%= mapper_wizard_save_path(search_endpoint_id) %>"
     data-mapper-wizard-has-existing-mappers-value="<%= @has_existing_mappers %>">

  <div class="card-body">
    <!-- Status Alert -->
    <div data-mapper-wizard-target="status" class="alert" style="display: none;"></div>

    <!-- Step 1: Fetch HTML -->
    <div class="mb-4">
      <h4><span class="badge bg-primary">1</span> Fetch Search Results HTML</h4>
      <p class="text-muted">Enter a URL of a search results page to fetch its HTML content.</p>

      <div class="row g-3">
        <div class="col-md-2">
          <label for="httpMethod" class="form-label">HTTP Method</label>
          <select class="form-select"
                  id="httpMethod"
                  data-mapper-wizard-target="httpMethod"
                  data-action="change->mapper-wizard#updateTestQueryHint">
            <option value="GET" <%= @search_endpoint.api_method == 'GET' || !@search_endpoint.persisted? ? 'selected' : '' %>>GET</option>
            <option value="POST" <%= @search_endpoint.api_method == 'POST' ? 'selected' : '' %>>POST</option>
          </select>
        </div>
        <div class="col-md-8">
          <label for="searchUrl" class="form-label">Search URL (Base)</label>
          <input type="url"
                 class="form-control"
                 id="searchUrl"
                 placeholder="https://opensourceconnections.com/"
                 data-mapper-wizard-target="searchUrl"
                 value="<%= @search_endpoint.endpoint_url %>">
          <div class="form-text">Base URL saved to endpoint.</div>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="button"
                  class="btn btn-primary w-100"
                  data-mapper-wizard-target="fetchButton"
                  data-action="click->mapper-wizard#fetchHtml">
            <i class="bi bi-download"></i> Fetch
          </button>
        </div>
      </div>

      <!-- Test Query (used for both GET query params and POST body) -->
      <% existing_test_query = @wizard_state.try(:test_query).presence || @search_endpoint.test_query %>
      <div class="row g-3 mt-2">
        <div class="col-12">
          <label for="testQuery" class="form-label">Test Query</label>
          <textarea class="form-control"
                    id="testQuery"
                    rows="4"
                    data-mapper-wizard-target="testQuery"
                    placeholder="<%= @search_endpoint.api_method == 'POST' ? '{"query": "test", "size": 10}' : 'q=shirts&rows=10' %>"><%= existing_test_query %></textarea>
          <div class="form-text" data-mapper-wizard-target="testQueryHint">
            <% if @search_endpoint.api_method == 'POST' %>
              Enter JSON body for POST request. Saved with endpoint for easy iteration.
            <% else %>
              Enter query params (e.g., <code>q=test&rows=10</code>) appended to URL. Saved with endpoint for easy iteration.
            <% end %>
          </div>
        </div>
      </div>

      <!-- Advanced Options -->
      <% existing_headers = @wizard_state.try(:custom_headers).presence || @search_endpoint.custom_headers %>
      <% existing_basic_auth = @wizard_state.try(:basic_auth_credential).presence || @search_endpoint.basic_auth_credential %>
      <% show_advanced = existing_headers.present? || existing_basic_auth.present? %>
      <div class="row g-3 mt-2">
        <div class="col-12">
          <a class="text-decoration-none" data-bs-toggle="collapse" href="#customHeadersSection" role="button" aria-expanded="false" aria-controls="customHeadersSection">
            <i class="bi bi-gear"></i> Advanced Options
          </a>
          <div class="collapse <%= show_advanced ? 'show' : '' %>" id="customHeadersSection">
            <div class="mt-2">
              <label for="basicAuthCredential" class="form-label">Basic Auth Credential</label>
              <input type="text"
                     class="form-control"
                     id="basicAuthCredential"
                     data-mapper-wizard-target="basicAuthCredential"
                     placeholder="username:password"
                     value="<%= existing_basic_auth %>">
              <div class="form-text">Optional. Format: <code>username:password</code>. Used for HTTP Basic Authentication.</div>
            </div>
            <div class="mt-2">
              <label for="customHeaders" class="form-label">Custom HTTP Headers (JSON)</label>
              <textarea class="form-control"
                        id="customHeaders"
                        rows="3"
                        data-mapper-wizard-target="customHeaders"
                        data-codemirror-mode="application/json"
                        data-codemirror-line-numbers="true"
                        data-codemirror-height="100"
                        placeholder='{"X-Api-Key": "your-api-key", "Authorization": "Bearer token"}'><%= format_custom_headers_for_form(existing_headers) %></textarea>
              <div class="form-text">Optional. Add custom headers as JSON object (e.g., API keys, authentication tokens). These will be saved with the search endpoint.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- HTML Preview -->
      <div class="mt-3" data-mapper-wizard-target="htmlPreviewContainer" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <label class="form-label mb-0">Fetched HTML/JSON Preview</label>
          <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-outline-secondary" data-action="click->mapper-wizard#copyHtmlPreview" title="Copy to clipboard">
              <i class="bi bi-clipboard"></i> Copy
            </button>
            <button type="button" class="btn btn-outline-secondary" data-action="click->mapper-wizard#toggleHtmlPreview">
              Expand
            </button>
          </div>
        </div>
        <pre class="bg-light p-3 border rounded html-preview"
             data-mapper-wizard-target="htmlPreview"
             style="max-height: 200px; overflow-y: auto; font-size: 12px; white-space: pre-wrap; word-wrap: break-word;"></pre>
      </div>
    </div>

    <hr>

    <!-- Step 2: Generate with AI -->
    <div class="mb-4" data-mapper-wizard-target="step2" style="display: none;">
      <h4><span class="badge bg-primary">2</span> Generate Mappers with AI</h4>
      <p class="text-muted">Enter your OpenAI API key to generate JavaScript mapper functions.</p>

      <div class="row g-3">
        <div class="col-md-8">
          <label for="apiKey" class="form-label">OpenAI API Key</label>
          <input type="password"
                 class="form-control"
                 id="apiKey"
                 placeholder="sk-..."
                 data-mapper-wizard-target="apiKey">
          <div class="form-text">Your API key is used only for this request and is not stored.</div>
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="button"
                  class="btn btn-success w-100"
                  data-mapper-wizard-target="generateButton"
                  data-action="click->mapper-wizard#generateMappers">
            <i class="bi bi-stars"></i> Generate Mappers with AI
          </button>
        </div>
      </div>
    </div>

    <hr>

    <!-- Step 3: Edit, Test, and Refine -->
    <div class="mb-4" data-mapper-wizard-target="step3" style="display: none;">
      <h4><span class="badge bg-primary">3</span> Edit, Test &amp; Refine</h4>
      <p class="text-muted">Test your mapper functions and refine them as needed. You can edit the code directly or ask AI for improvements.</p>

      <!-- numberOfResultsMapper -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>numberOfResultsMapper</strong>
          <div class="btn-group btn-group-sm">
            <button type="button"
                    class="btn btn-outline-primary"
                    data-mapper-wizard-target="testNumberButton"
                    data-action="click->mapper-wizard#testNumberOfResultsMapper">
              <i class="bi bi-play-fill"></i> Test
            </button>
            <button type="button"
                    class="btn btn-outline-warning"
                    data-mapper-wizard-target="refineNumberButton"
                    data-action="click->mapper-wizard#refineNumberOfResultsMapper">
              <i class="bi bi-stars"></i> Refine with AI
            </button>
          </div>
        </div>
        <div class="card-body">
          <textarea data-mapper-wizard-target="numberOfResultsMapper"
                    data-codemirror-mode="javascript"
                    data-codemirror-line-numbers="true"
                    data-codemirror-height="200"><%= @existing_number_of_results_mapper || @wizard_state.try(:number_of_results_mapper) || "numberOfResultsMapper = function(data) {\n  // Return total number of search results\n  return 0;\n}" %></textarea>
          <div class="mt-2">
            <strong>Test Result:</strong>
            <div data-mapper-wizard-target="numberOfResultsResult" class="p-2 bg-light border rounded">
              <em class="text-muted">Click "Test" to see results</em>
            </div>
          </div>
          <div class="mt-2" data-mapper-wizard-target="numberOfResultsLogsContainer" style="display: none;">
            <strong>Console Logs:</strong>
            <div data-mapper-wizard-target="numberOfResultsLogs" class="p-2 bg-dark text-light border rounded" style="max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 12px;">
            </div>
          </div>
        </div>
      </div>

      <!-- docsMapper -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>docsMapper</strong>
          <div class="btn-group btn-group-sm">
            <button type="button"
                    class="btn btn-outline-primary"
                    data-mapper-wizard-target="testDocsButton"
                    data-action="click->mapper-wizard#testDocsMapper">
              <i class="bi bi-play-fill"></i> Test
            </button>
            <button type="button"
                    class="btn btn-outline-warning"
                    data-mapper-wizard-target="refineDocsButton"
                    data-action="click->mapper-wizard#refineDocsMapper">
              <i class="bi bi-stars"></i> Refine with AI
            </button>
          </div>
        </div>
        <div class="card-body">
          <textarea data-mapper-wizard-target="docsMapper"
                    data-codemirror-mode="javascript"
                    data-codemirror-line-numbers="true"
                    data-codemirror-height="300"><%= @existing_docs_mapper || @wizard_state.try(:docs_mapper) || "docsMapper = function(data) {\n  // Return array of {id, title, ...} objects\n  var docs = [];\n  return docs;\n}" %></textarea>
          <div class="mt-2">
            <strong>Test Result:</strong>
            <div data-mapper-wizard-target="docsResult" class="p-2 bg-light border rounded" style="max-height: 300px; overflow-y: auto;">
              <em class="text-muted">Click "Test" to see results</em>
            </div>
          </div>
          <div class="mt-2" data-mapper-wizard-target="docsLogsContainer" style="display: none;">
            <strong>Console Logs:</strong>
            <div data-mapper-wizard-target="docsLogs" class="p-2 bg-dark text-light border rounded" style="max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 12px;">
            </div>
          </div>
        </div>
      </div>
    </div>

    <hr>

    <!-- Step 4: Save -->
    <div class="mb-4">
      <h4><span class="badge bg-primary">4</span> Save Search Endpoint</h4>

      <div class="row g-3">
        <div class="col-md-6">
          <label for="endpointName" class="form-label">Endpoint Name</label>
          <input type="text"
                 class="form-control"
                 id="endpointName"
                 placeholder="My Search API"
                 data-mapper-wizard-target="endpointName"
                 value="<%= @search_endpoint.name %>">
        </div>
        <div class="col-md-6">
          <label class="form-label">Options</label>
          <div class="form-check form-switch">
            <input type="checkbox"
                   class="form-check-input"
                   id="proxyRequests"
                   data-mapper-wizard-target="proxyRequests"
                   <%= @search_endpoint.proxy_requests? || !@search_endpoint.persisted? ? 'checked' : '' %>>
            <label class="form-check-label" for="proxyRequests">Proxy requests through Quepid</label>
          </div>
          <div class="form-text">Recommended for avoiding CORS issues with external search APIs.</div>
        </div>
      </div>

      <% if @current_user.teams.any? %>
        <div class="row g-3 mt-2">
          <div class="col-12">
            <label class="form-label">Share with Teams</label>
            <div data-mapper-wizard-target="teamsContainer">
              <% existing_team_ids = @search_endpoint.persisted? ? @search_endpoint.team_ids : [] %>
              <% auto_check_single = @current_user.teams.count == 1 && !@search_endpoint.persisted? %>
              <% @current_user.teams.each do |team| %>
                <div class="form-check">
                  <input type="checkbox"
                         class="form-check-input"
                         id="team_<%= team.id %>"
                         value="<%= team.id %>"
                         data-mapper-wizard-target="teamCheckbox"
                         <%= existing_team_ids.include?(team.id) || auto_check_single ? 'checked' : '' %>>
                  <label class="form-check-label" for="team_<%= team.id %>"><%= team.name %></label>
                </div>
              <% end %>
            </div>
            <div class="form-text">Select which teams can use this search endpoint.</div>
          </div>
        </div>
      <% end %>

      <div class="mt-3">
        <button type="button"
                class="btn btn-lg btn-success"
                data-mapper-wizard-target="saveButton"
                data-action="click->mapper-wizard#save">
          <i class="bi bi-check-circle"></i> Save Search Endpoint
        </button>
        <span class="text-muted ms-3">HTTP method and URL from Step 1 will be saved.</span>
      </div>
    </div>
  </div>
</div>

<style>
  .html-preview.expanded {
    max-height: 600px !important;
  }
</style>
