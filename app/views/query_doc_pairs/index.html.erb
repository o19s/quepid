<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1>Query Doc Pairs for <i class="bi bi-book"></i> <%= book_title(@book) %></h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <div class="btn-group me-2">
      <%= link_to 'New Query Doc Pair', new_book_query_doc_pair_path, class: 'btn btn-sm btn-outline-secondary' %>
      <%= link_to "Back to Book", @book, class: 'btn btn-sm btn-outline-secondary' %>    
    </div>
  </div>
</div>

<%= render 'books/tabs', book: @book %>

<div class="card h-100" data-controller="document-fields-modal">
  <div class="card-header">
    <%= form_tag(book_query_doc_pairs_path(@book), { method: :get }) do %>
      <div class="mb-0 d-flex flex-wrap align-items-center gap-3 fs-6">

        <div class="input-group max-w-400">
          <%= text_field_tag :q, params[:q],
              class: 'form-control form-control-sm',
              placeholder: 'Filter by query, doc id, or document field contents',
              id: 'q'
          %>
          <%= button_tag type: 'submit', class: 'btn btn-sm btn-outline-secondary', id: 'button-addon2' do %>
            <i class="bi bi-search-heart"></i>
          <% end %>
        </div>

        <div class="form-check form-check-inline mb-0">
          <%= check_box_tag :include_judgement_count,
              true,
              @include_judgement_count,
              class: 'form-check-input',
              id: 'include_judgement_count',
              onchange: 'this.form.submit()'
          %>
          <label class="form-check-label" for="include_judgement_count">Include Judgement Count</label>
        </div>

      </div>
    <% end %>
  </div>
  
  <div class="card-body">
    <table class="table table-hover table-sm">
      <thead>
        <tr>
          <th>ID</th>
          <th>Query text</th>
          <th>Position</th>
          <th>Doc ID</th>
          <% if @include_judgement_count %>
            <th>Judgements</th>
          <% end %>
          <th>Document fields</th>
        </tr>
      </thead>
  
      <tbody>      
        <% @query_doc_pairs.each do |query_doc_pair| %>
          <tr>
            <td>
              <%= link_to query_doc_pair.id, book_query_doc_pair_path(@book, query_doc_pair) %>
            </td>
      
            <td><%= query_doc_pair.query_text %></td>
            <td><%= query_doc_pair.position %></td>
            <td><%= query_doc_pair.doc_id %></td>
            <% if @include_judgement_count %>
              <td>
                <%= link_to_if query_doc_pair.judgements_count>0, query_doc_pair.judgements_count, book_judgements_path(@book, q: "query_doc_pair_id:#{query_doc_pair.id}") %>
              </td>
            <% end %>            
            <td>
              <% if query_doc_pair.document_fields.present? %>
                <% document_fields_json = query_doc_pair.document_fields.to_json %>
                <%= truncate(document_fields_json, length: 90) %>
                <a href="#"
                   class="ms-1"
                   data-action="click->document-fields-modal#show"
                   data-document-fields="<%= document_fields_json %>"
                   data-query-text="<%= query_doc_pair.query_text %>"
                   data-doc-id="<%= query_doc_pair.doc_id %>"
                   title="View full document fields">
                  <i class="bi bi-info-circle-fill text-dark"></i>
                </a>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  <div class="card-footer d-flex justify-content-center">
    <%== @pagy.series_nav(:bootstrap) %> 
  </div>

  <!-- Document Fields Modal -->
  <div class="modal fade" id="documentFieldsModal" tabindex="-1" aria-labelledby="documentFieldsModalLabel" aria-hidden="true" data-document-fields-modal-target="modal">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="documentFieldsModalLabel">Document Fields</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-2">
            <strong>Query:</strong> <span data-document-fields-modal-target="queryText"></span><br>
            <strong>Doc ID:</strong> <span data-document-fields-modal-target="docId"></span>
          </p>
          <pre data-document-fields-modal-target="content" class="bg-light p-3 rounded" class="text-pre-wrap"></pre>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>
