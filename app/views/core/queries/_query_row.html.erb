<%# Single query row for the query list. Uses unique id (query_row_<id>) for Turbo Stream targeting. %>
<%# Used by QueryListComponent and Turbo Stream responses (e.g. append after create, remove after delete). %>
<% query_id = query.respond_to?(:id) ? query.id : nil %>
<% query_text = query.respond_to?(:query_text) ? query.query_text : query[:query_text] %>
<li id="query_row_<%= query_id %>"
    class="list-group-item py-2"
    data-query-id="<%= query_id %>"
    data-query-text="<%= query_text.to_s.downcase %>"
    data-query-score="<%= local_assigns[:query_score] %>"
    data-query-modified="<%= query.respond_to?(:updated_at) ? query.updated_at.to_i : 0 %>"
    data-query-error="<%= local_assigns[:query_score].to_s == '?' || local_assigns[:query_score].to_s == '' ? 'true' : 'false' %>"
    data-controller="query-expand"
    data-query-expand-case-id-value="<%= local_assigns[:case_id] %>"
    data-query-expand-try-number-value="<%= local_assigns[:try_number] %>"
    data-query-expand-query-id-value="<%= query_id %>"
    data-query-expand-scale-value="<%= (local_assigns[:scorer_scale] || [0,1,2,3]).to_json %>">
    <div class="d-flex flex-wrap align-items-center gap-2">
      <button type="button" class="btn btn-sm btn-link p-0 text-muted query-expand-chevron" data-action="click->query-expand#toggle" data-query-expand-target="chevron" title="Preview results" aria-label="Expand inline results">
        <i class="bi bi-chevron-right" aria-hidden="true"></i>
      </button>
      <% if local_assigns[:sortable] %>
        <span class="query-drag-handle text-muted cursor-grab" title="Drag to reorder" aria-hidden="true"><i class="bi bi-grip-vertical"></i></span>
      <% end %>
      <span class="text-dark flex-grow-1 text-break" role="button" style="cursor: pointer;"
            data-action="click->query-expand#toggle">
        <%= query_text %>
      </span>
      <% if local_assigns[:unrated] %>
        <span class="badge bg-warning text-dark" title="No ratings for this query"><i class="bi bi-exclamation-triangle-fill" aria-hidden="true"></i></span>
      <% end %>
      <span class="d-flex align-items-center gap-1 flex-shrink-0">
        <%= render QscoreQueryComponent.new(
              score: local_assigns[:query_score] || "?",
              max_score: local_assigns[:scorer_scale_max] || 100,
              query_id: query_id,
              css_class: "badge rounded-pill"
            ) %>
        <%= render MoveQueryComponent.new(
              query_id: query_id,
              case_id: local_assigns[:case_id],
              other_cases: local_assigns[:other_cases] || [],
              try_number: local_assigns[:try_number]
            ) %>
        <%= render QueryOptionsComponent.new(
              query_id: query_id,
              case_id: local_assigns[:case_id],
              options_json: local_assigns[:options_json]
            ) %>
        <%= render QueryExplainComponent.new(query_id: query_id) %>
        <% if query_id %>
          <%= render DeleteQueryComponent.new(
                case_id: local_assigns[:case_id],
                query_id: query_id,
                query_text: query_text,
                try_number: local_assigns[:try_number]
              ) %>
        <% end %>
      </span>
    </div>
    <div class="query-inline-results d-none" data-query-expand-target="inlineResults"></div>
</li>
