<%
  # User status checks
  current_user_has_judged_all = SelectionStrategy.user_has_judged_all_available_pairs?(book, current_user)
  user_has_judged_some = book.judgements.where(user: current_user).exists?
  user_judgement_count = book.judgements.where(user: current_user).count
  
  # Book statistics
  total_pairs = book.query_doc_pairs.count
  unjudged_pairs = SelectionStrategy.unjudged_pairs_count(book)
  partially_judged_pairs = SelectionStrategy.partially_judged_pairs_count(book)
  unjudged_pairs = SelectionStrategy.unjudged_pairs?(book)
%>

<% if book.query_doc_pairs.empty? %>
  <div class="alert alert-warning" role="alert">
    <h5><i class="bi bi-exclamation-triangle"></i> No Query/Doc Pairs Available</h5>
    <p class="mb-2">You don't have any query/doc pairs created yet.</p>
    <% if book.cases.empty? %>
      <p>You can populate this Book with query/doc pairs for judging by <%= link_to 'picking a Case', cases_path, class: 'alert-link' %> and using the <strong><i class="bi bi-book-half"></i> Judgements</strong> tool to populate this book with query/doc pairs from your search engine.</p>
    <% else %>
      <p>Return to the linked Case
      <% book.cases.each do |kase| %>
        <%= link_to_core_case case_title(kase), kase, kase.last_try_number, class: 'alert-link' %>
      <% end %>
      and use the <strong><i class="bi bi-book-half"></i> Judgements</strong> tool to populate this Book with query/doc pairs for judging.</p>
    <% end %>
  </div>

<% elsif current_user_has_judged_all && !@moar_judgements_needed %>
  <!-- User has judged everything and book is complete -->
  <div class="alert alert-success" role="alert">
    <h5><i class="bi bi-check-circle"></i> All Done!</h5>
    <p class="mb-0">Congratulations! You have judged all <%= pluralize(total_pairs, 'query/doc pair') %>, and all pairs have been judged by three separate judges. This book is complete!</p>
  </div>

<% elsif current_user_has_judged_all && @moar_judgements_needed %>
  <!-- User has judged all their available pairs but book needs more judgements from others -->
  <div class="alert alert-info" role="alert">
    <h5><i class="bi bi-person-check"></i> You Have Judged All Available Pairs</h5>
    <p class="mb-2">You have completed judging all <%= pluralize(user_judgement_count, 'query/doc pair') %> available to you.</p>
    <p class="mb-0">Some pairs still need additional judgements from other judges to reach the best practice of 3 judgements each.</p>
  </div>

<% elsif @moar_judgements_needed %>
  <!-- More judgements are needed and user can contribute -->
  <% if unjudged_pairs %>
    <div class="alert alert-warning" role="alert">
      <h5><i class="bi bi-exclamation-circle"></i> Critical: Unjudged Pairs Need Attention</h5>
      <% if user_has_judged_some %>
          <p class="mb-2">You have judged <%= user_judgement_count %> out of <%= pluralize(total_pairs, 'query/doc pair') %>.</p>
      <% end %>
      <p class="mb-3">
        <strong>High Priority:</strong> There <%= (total_pairs - partially_judged_pairs) == 1 ? 'is' : 'are' %> <%= pluralize(total_pairs - partially_judged_pairs, 'pair') %> that <%= (total_pairs - partially_judged_pairs) == 1 ? 'has' : 'have' %> <strong>no judgements yet</strong> and need immediate attention.
        <% if partially_judged_pairs > 0 %>
          <br>
          Additionally, <%= pluralize(partially_judged_pairs, 'pair') %> <%= partially_judged_pairs == 1 ? 'has' : 'have' %> fewer than 3 judgements each, with 3 being best practice.
        <% end %>
      </p>
      
      <div class="d-grid gap-2 d-md-flex">
        <%= link_to book_judge_path(book), class: 'btn btn-primary', role: 'button' do %>
          <i class="bi bi-lightning-fill"></i> Start with Unjudged Pairs
        <% end %>
        <%= link_to book_judge_bulk_path(book), class: 'btn btn-outline-primary', role: 'button' do %>
          <i class="bi bi-lightning"></i> Judge in Bulk
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="alert alert-warning" role="alert">
      <h5><i class="bi bi-clipboard-check"></i> Finishing Up Judgements</h5>
      <% if user_has_judged_some %>
        <p class="mb-2">You have judged <%= user_judgement_count %> out of <%= pluralize(total_pairs, 'query/doc pair') %>.</p>
      <% end %>
      <p class="mb-3">
        Good progress! All pairs have at least one judgement, but <%= pluralize(partially_judged_pairs, 'pair') %> still <%= partially_judged_pairs == 1 ? 'needs' : 'need' %> additional judgements to reach our target of 3 judgements each for quality assurance.
      </p>
      
      <div class="d-grid gap-2 d-md-flex">
        <%= link_to book_judge_path(book), class: 'btn btn-primary', role: 'button' do %>
          <i class="bi bi-play-circle"></i> Continue Judging
        <% end %>
        <%= link_to book_judge_bulk_path(book), class: 'btn btn-info', role: 'button' do %>
          <i class="bi bi-lightning"></i> Judge in Bulk
        <% end %>
      </div>
    </div>
  <% end %>

<% else %>
  <!-- All judgements complete -->
  <div class="alert alert-success" role="alert">
    <h5><i class="bi bi-trophy"></i> Book Complete!</h5>
    <p class="mb-0">Congratulations! All <%= pluralize(total_pairs, 'query/doc pair') %> have been judged by three separate judges. This book is ready for analysis.</p>
  </div>
<% end %>

<p/>
