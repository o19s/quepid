<div class="card">
  <div class="card-body">
    <h5 class="card-title">Cases</h5>
    <div class="table-responsive">
      <div class="mb-3">
        <%= form_with url: team2_path(@team), method: :get, local: true, html: { class: 'row g-2 align-items-center' } do %>
          <div class="col-auto" style="flex:1">
            <div class="input-group">
              <%= text_field_tag :q, @filter_q.presence || params[:q], class: 'form-control form-control-sm', placeholder: 'Filter by case name or id' %>
              <button class="btn btn-sm btn-outline-secondary" type="submit" title="Search">
                <i class="bi bi-search" aria-hidden="true"></i>
                <span class="visually-hidden">Search</span>
              </button>
            </div>
          </div>
          <div class="col-auto form-check form-check-inline mb-0 ms-3 ms-md-4">
            <%= check_box_tag :archived, '1', @archived, class: 'form-check-input', id: 'archived-cases-checkbox', onchange: 'this.form.submit()' %>
            <%= label_tag 'archived-cases-checkbox', 'Archived Cases', class: 'form-check-label' %>
          </div>
        <% end %>
      </div>

      <table class="table table-sm table-hover">
        <thead>
          <tr>
            <th>ID</th>
            <th>Case Title</th>
            <th>Last Try #</th>
            <th># of Queries</th>
            <th>Last Score</th>
            <th>Last Run On</th>
            <th>Last Run By</th>
            <th>Associated Judgements</th>
            <th>Teams</th>
            <th>Owner</th>
            <th class="text-end"></th>
          </tr>
        </thead>
        <tbody>
          <% @cases.each do |kase| %>
            <% last_score = kase.last_score %>
            <tr>
              <td><%= kase.id %></td>
              <td><%= link_to kase.case_name, case_core_path(kase) %></td>
              <td><%= kase.last_try_number || (kase.tries.first&.try_number) %></td>
              <td><%= kase.respond_to?(:queries_count) ? kase.queries_count : kase.queries.size %></td>
              <td>
                <% if last_score.present? %>
                  <%= number_with_precision(last_score.score || 0, precision: 3) %>
                <% else %>
                  Never Run
                <% end %>
              </td>
              <td>
                <% if last_score.present? && last_score.updated_at.present? %>
                  <%= l(last_score.updated_at, format: :short) %>
                <% else %>
                  —
                <% end %>
              </td>
              <td>
                <% if last_score.present? %>
                  <%= last_score.user&.fullname || 'System' %>
                <% else %>
                  —
                <% end %>
              </td>
              <td><%= kase.ratings.count %></td>
              <td>
                <% if kase.teams.any? %>
                  <%= safe_join(kase.teams.map { |t| link_to t.name, team2_path(t) }, ', ') %>
                <% else %>
                  —
                <% end %>
              </td>
              <td><%= kase.owner&.fullname || '—' %></td>
              <td class="text-end">
                <div class="btn-group btn-group-sm" role="group">
                  <%= button_tag type: 'button',
                                 class: 'btn btn-link p-0 me-2',
                                 title: 'Share',
                                 'aria-label': 'Share',
                                 data: {
                                   controller: 'share-case',
                                   action: 'click->share-case#open',
                                   bs_toggle: 'modal',
                                   bs_target: '#shareCaseModal',
                                   share_case_id_value: kase.id,
                                   share_case_name_value: kase.case_name,
                                   share_case_all_teams_json: current_user.teams.select(:id, :name).order(:name).to_json,
                                   share_case_shared_teams_json: kase.teams.select(:id, :name).to_json
                                 } do %>
                    <i class="bi bi-share" aria-hidden="true"></i>
                  <% end %>

                  <% if kase.archived? %>
                    <button type="button"
                            class="btn btn-link text-success p-0 me-3"
                            title="Unarchive case"
                            aria-label="Unarchive case"
                            data-controller="confirm-delete"
                            data-action="click->confirm-delete#open"
                            data-confirm-delete-url-value="<%= team2_unarchive_case_path(@team, case_id: kase.id) %>"
                            data-confirm-delete-method-value="post"
                            data-confirm-delete-message-value="<%= h("Unarchive #{kase.case_name}?") %>">
                      <i class="bi-folder-check" aria-hidden="true"></i>
                      <span class="visually-hidden">Unarchive case</span>
                    </button>
                  <% else %>
                    <button type="button"
                            class="btn btn-link text-warning p-0 me-3"
                            title="Archive case"
                            aria-label="Archive case"
                            data-controller="confirm-delete"
                            data-action="click->confirm-delete#open"
                            data-confirm-delete-url-value="<%= team2_archive_case_path(@team, case_id: kase.id) %>"
                            data-confirm-delete-method-value="post"
                            data-confirm-delete-message-value="<%= h("Archive #{kase.case_name}?") %>">
                      <i class="bi-folder-check" aria-hidden="true"></i>
                      <span class="visually-hidden">Archive case</span>
                    </button>
                  <% end %>


                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>
