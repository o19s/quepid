<%# Settings panel: current try display (search URL, engine) and editable query params (try settings). %>
<%# Replaces SettingsCtrl, CurrSettingsCtrl, QueryParamsPanelComponent. Query options per-query in list. %>
<div class="settings-panel-wrapper" data-controller="settings-panel" data-settings-panel-case-id-value="<%= @case_id %>" data-settings-panel-try-number-value="<%= @try&.try_number %>" data-settings-panel-curator-vars-value="<%= h(curator_vars_json) %>" data-settings-panel-search-engine-value="<%= search_engine %>" data-settings-panel-tries-count-value="<%= tries.size %>">
  <button type="button" class="btn btn-outline-secondary btn-sm" data-action="click->settings-panel#toggle" data-settings-panel-target="trigger">
    <i class="bi bi-gear" aria-hidden="true"></i>
    Settings
  </button>
  <div class="settings-panel-content collapse mt-2" data-settings-panel-target="panel">
    <div class="card card-body small">
      <h6 class="card-title">Current try</h6>
      <dl class="mb-0 mb-2">
        <dt class="text-muted">Name</dt>
        <dd class="mb-1"><%= try_name %></dd>
        <dt class="text-muted">Search engine</dt>
        <dd class="mb-1"><%= search_engine %></dd>
        <dt class="text-muted">Search URL</dt>
        <dd class="mb-0 d-flex align-items-center gap-1">
          <code class="small" data-clipboard-target="source"><%= search_url %></code>
          <button type="button" class="btn btn-sm btn-link p-0 text-muted" data-controller="clipboard" data-clipboard-text-value="<%= search_url %>" data-action="click->clipboard#copy" title="Copy URL">
            <i class="bi bi-clipboard" aria-hidden="true"></i>
          </button>
        </dd>
      </dl>
      <div class="d-flex gap-2 align-items-center mb-2">
        <% if @search_endpoint_edit_path %>
          <%= link_to "Edit search endpoint", @search_endpoint_edit_path, class: "btn btn-sm btn-outline-primary" %>
        <% end %>
        <button type="button" class="btn btn-sm btn-outline-info" data-action="click->settings-panel#validateUrl" title="Test connection to search endpoint">
          <i class="bi bi-plug" aria-hidden="true"></i> Test connection
        </button>
      </div>
      <div class="d-none small mb-2" data-settings-panel-target="urlValidationFeedback"></div>
      <div class="d-none alert alert-warning py-1 px-2 small mb-2" data-settings-panel-target="templateCallFeedback">
        <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
        This endpoint uses <code>_search/template</code>. Make sure your query params are formatted as a search template request body.
      </div>
      <% if search_endpoints.any? %>
        <div class="mb-2">
          <label class="form-label small text-muted mb-1">Search endpoint</label>
          <select class="form-select form-select-sm" data-settings-panel-target="endpointSelect" data-action="change->settings-panel#changeEndpoint">
            <% search_endpoints.each do |ep| %>
              <option value="<%= ep.id %>" <%= "selected" if ep.id == current_search_endpoint_id %>><%= ep.name.presence || ep.endpoint_url %> (<%= ep.search_engine %>)</option>
            <% end %>
          </select>
        </div>
      <% end %>
      <h6 class="card-title mt-2">Query params (try config)</h6>
      <% if @try.present? && @case_id.present? %>
        <form data-settings-panel-target="paramsForm" data-action="submit->settings-panel#saveParams">
          <div class="mb-2">
            <label class="form-label small text-muted mb-1">Query parameters</label>
            <textarea class="form-control form-control-sm font-monospace" rows="5" style="max-height: 200px; overflow: auto;"
                      data-settings-panel-target="queryParams"
                      data-codemirror-mode="json"
                      data-action="input->settings-panel#extractVars blur->settings-panel#validateQueryParams"><%= query_params_full %></textarea>
            <div class="d-none small mt-1" data-settings-panel-target="queryParamsFeedback"></div>
          </div>
          <div data-settings-panel-target="curatorVarsContainer"></div>
          <div class="form-check mb-2">
            <input type="checkbox" class="form-check-input" id="settings-escape-query"
                   data-settings-panel-target="escapeQuery" <%= "checked" if escape_query? %>>
            <label class="form-check-label small" for="settings-escape-query">Escape query</label>
          </div>
          <div class="mb-2">
            <label class="form-label small text-muted mb-1" for="settings-number-of-rows">Number of rows</label>
            <input type="number" class="form-control form-control-sm" id="settings-number-of-rows"
                   min="1" max="1000" value="<%= number_of_rows %>"
                   data-settings-panel-target="numberOfRows" style="max-width: 100px;">
          </div>
          <button type="submit" class="btn btn-sm btn-primary">
            <i class="bi bi-save" aria-hidden="true"></i> Save &amp; re-run
          </button>
        </form>
      <% else %>
        <p class="text-muted small mb-1">No try selected.</p>
      <% end %>
      <% if tries.any? %>
        <hr class="my-2">
        <h6 class="card-title">
          <a class="text-decoration-none" data-bs-toggle="collapse" href="#try-history-section" role="button" aria-expanded="false" aria-controls="try-history-section">
            <i class="bi bi-clock-history" aria-hidden="true"></i> Try history (<%= tries.size %>)
          </a>
        </h6>
        <div class="collapse" id="try-history-section">
          <div class="list-group list-group-flush small">
            <% tries.each_with_index do |t, idx| %>
              <div class="list-group-item px-0 py-1 d-flex justify-content-between align-items-center<%= t.try_number == @try&.try_number ? ' bg-light' : '' %><%= idx >= 20 ? ' d-none js-try-history-extra' : '' %>" style="border-left: 4px solid <%= url_color_for_try(t) %>; padding-left: 6px;">
                <div class="flex-grow-1">
                  <% if t.try_number == @try&.try_number %>
                    <strong>Try <%= t.try_number %></strong>
                  <% else %>
                    <a href="<%= helpers.case_core_path(@case_id, t.try_number) %>"><strong>Try <%= t.try_number %></strong></a>
                  <% end %>
                  <% if t.name.present? %>
                    <span class="text-muted">â€” <%= t.name %></span>
                  <% end %>
                  <% if t.search_endpoint %>
                    <span class="badge bg-secondary ms-1"><%= t.search_endpoint.search_engine %></span>
                  <% end %>
                  <% changes = try_diffs[t.try_number] %>
                  <% if changes.present? %>
                    <span class="badge bg-warning text-dark ms-1" title="Changed: <%= changes.join(', ') %>"><i class="bi bi-pencil-fill" aria-hidden="true"></i> <%= changes.size %> change<%= changes.size != 1 ? 's' : '' %></span>
                  <% end %>
                  <span class="text-muted ms-1"><time datetime="<%= t.created_at.iso8601 %>" data-local="time-ago"><%= t.created_at.strftime("%b %d, %H:%M") %></time></span>
                </div>
                <div class="d-flex gap-1">
                  <% if t.try_number != @try&.try_number %>
                    <button type="button" class="btn btn-sm btn-outline-secondary py-1 px-2"
                            data-action="click->settings-panel#duplicateTry"
                            data-try-number="<%= t.try_number %>"
                            title="Duplicate this try"
                            aria-label="Duplicate try <%= t.try_number %>">
                      <i class="bi bi-copy" aria-hidden="true"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger py-1 px-2"
                            data-action="click->settings-panel#deleteTry"
                            data-try-number="<%= t.try_number %>"
                            title="Delete this try"
                            aria-label="Delete try <%= t.try_number %>">
                      <i class="bi bi-trash" aria-hidden="true"></i>
                    </button>
                  <% else %>
                    <span class="badge bg-primary">current</span>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
          <% if tries.size > 20 %>
            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" data-settings-panel-target="tryHistoryToggle" data-action="click->settings-panel#toggleTryHistory">
              Show all <%= tries.size %> tries
            </button>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
