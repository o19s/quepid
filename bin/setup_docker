#!/usr/bin/env bash
set -e

# path to your application root.
APP_ROOT=$(dirname $(dirname $(realpath "$0")))

cd $APP_ROOT

# This script is a starting point to setup your application.
# Add necessary setup steps to this file:

echo -e "\n== Copying sample files =="
if [ ! -f "config/database.yml" ]; then
  cp config/database.yml.sample config/database.yml
fi

if [ ! -f ".env" ]; then
  cp .env.example .env
fi

echo -e "\n== Teardown Existing Quepid =="
docker compose down -v

# Specifying nobuild will force use of existing image
build_arg="--build"
if [ $# -gt 0 ] && [ "$1" = "nobuild" ]; then
  build_arg="--no-build"
  echo -e "\n== Pulling latest image =="
  docker compose pull app
fi

echo -e "\n== Building Docker container =="
docker compose up ${build_arg} --no-start --remove-orphans

bin/docker r bundle config set --local no-document true

bin/docker r yarn
bin/docker r ./wait-for mysql:3306 --timeout=60 -- bin/rake db:setup
bin/docker r bin/rake db:migrate

echo -e "\n== Removing old logs and tempfiles =="
bin/docker r rails log:clear tmp:clear

echo -e "\n== Setting up stupid simple model to power LLM as a Judge for Development =="
docker exec ollama ollama pull qwen3:0.6b

echo -e "\n== Setting up Seed Data for Development =="
bin/docker r bundle exec thor sample_data:sample_data
