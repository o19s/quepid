#!/usr/bin/env bash
set -e

# This is a wrapper script for docker-compose commands in the Quepid project
# Usage:
#   bin/docker server|s                  # Start the app
#   bin/docker bash|b                    # Connect to the app container with bash
#   bin/docker console|c                 # Connect to the Rails console
#   bin/docker run|r [COMMAND]           # Run any command
#   bin/docker daemon|q                  # Run dev mode as daemon
#   bin/docker destroy|d                 # Destroy the Docker env

# Get the project root directory
APP_ROOT=$(dirname $(dirname $(realpath "$0")))
cd "$APP_ROOT"

case "$1" in
  server|s)
    docker compose up --no-deps -d nginx
    docker compose run --rm --service-ports app foreman s -f Procfile.dev
    ;;
  bash|b)
    docker compose run --rm app bash
    ;;
  console|c)
    docker compose run --rm app rails console # add -e test for test environment
    ;;
  run|r)
    shift
    docker compose --progress=quiet run --rm app $@
    ;;
  daemon|q)
    #docker compose up -d
    docker compose run -d --service-ports app foreman s -f Procfile.dev
    ;;
  destroy|d)
    docker compose down
    ;;
  *)
    echo "Unknown command: $1"
    echo "Usage:"
    echo "  bin/docker server|s                  # Start the app"
    echo "  bin/docker bash|b                    # Connect to the app container with bash"
    echo "  bin/docker console|c                 # Connect to the Rails console"
    echo "  bin/docker run|r [COMMAND]           # Run any command"
    echo "  bin/docker daemon|q                  # Run dev mode as daemon"
    echo "  bin/docker destroy|d                 # Destroy the Docker env"
    exit 1
    ;;
esac
